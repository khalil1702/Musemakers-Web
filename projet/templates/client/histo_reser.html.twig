{% extends 'nav_foot_client.html.twig' %}

{% block myReservations %}
  <div class="container mt-7">
  
  
    <div class="row mb-3 justify-content-center">
     
     
    <!-- Menu déroulant compact de tri -->
    <div class="dropdown">
      <button class="btn btn-secondary dropdown-toggle" type="button" id="sortDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded=false>
        trier par date
      </button>
      <div class="dropdown-menu dropdown-menu-right" aria-labelledby="sortDropdown">
        <a class="dropdown-item" href="#">Plus ancien en premier</a>
        <a class="dropdown-item" href="#">Plus récent en premier</a>
      </div>
    </div>
  
       
  </div>

  <div class="row">
    <div class="col">
      <div class="card shadow">
        <div class="card-header border-0">
          <h3 class="mb-0">Liste des Reservations </h3>
        </div>
        <div class="table-responsive">
          <table class="table align-items-center table-flush">
            <thead class="thead-light">
              <tr>
                <th scope="col">Exposition</th>
                <th scope="col">Nombre de Tickets</th>
                <th scope="col">Status </th>
                <th scope="col">Action</th>
                <th scope="col">progres</th>
                <th scope="col">PDF</th>
              </tr>
            </thead>
            <tbody>
              {% for reservation in reservations %}
              <tr>
                <th scope="row">
                  {{ reservation.exposition.nom }}
                </th>
                <td>
                    {{ reservation.ticketsNumber }}
                    {% if reservation.accessByAdmin == 0 %}
                        <a href="#" class="btn btn-sm edit-btn" data-toggle="modal" data-target="#editModal{{ reservation.idReservation }}" style="background-color: #fb6340; border-color: #fb6340; color: #fff;">
                            <i class="fas fa-edit"></i> 
                        </a>
                    {% endif %}
                </td>
                
                <td>
                  <span class="badge badge-dot mr-4">
                    {% if reservation.accessByAdmin == 0 %}
                      <i class="bg-warning"></i> En cours
                    {% elseif reservation.accessByAdmin == 1 %}
                      <i class="bg-success"></i> accepté
                    {% elseif reservation.accessByAdmin == 2 %}
                      <i class="bg-danger"></i> refusé
                    {% elseif reservation.accessByAdmin == 3 %}
                      <i class="bg-default"></i> annulé
                    {% else %}
                      <i class="bg-gray"></i> unknown
                    {% endif %}
                  </span>
                </td>
                <td class="text-end px-1">
                  {% if reservation.accessByAdmin in [0, 1] %}
                    <a href="#" class="btn btn-sm btn-danger" data-toggle="tooltip" data-original-title="Cancel" data-href="{{ path('app_client_cancel_reservation', {'id': reservation.idReservation}) }}">
                      <i class="fas fa-times"></i>
                    </a>
                    {% else  %}
                    <a href="#" class="btn btn-sm btn-light disabled" data-original-title="Cancel">
                      <i class="fas fa-times"></i>
                    </a>
                  {% endif %}
                </td>


                  <td>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 
                        {% if reservation.accessByAdmin == 0 %} 50% {% elseif reservation.accessByAdmin in [2, 3] %} 100% {% else %} 100% {% endif %};
                        background-color: 
                        {% if reservation.accessByAdmin == 0 %} orange {% elseif reservation.accessByAdmin ==1 %} green {% else %} red {% endif %};">
                        </div>
                    </div>
                </td>
                {% if reservation.accessByAdmin == 1 %}
                <td>
                  <a href="{{ path('app_download_pdf', {'reservationId': reservation.idReservation}) }}" class="btn btn-sm btn-info"><i class="fas fa-download"></i> PDF</a>
                  <button type="button" class="btn btn-sm btn-info" onclick="openPdfModal('{{ path('app_view_pdf', {'reservationId': reservation.idReservation}) }}')"><i class="fas fa-eye"></i> PDF</button>
                </td>
                {% else %}
                <td>
                  <a href="#" class="btn btn-sm disabled" style="background-color: #e9ecef; border-color: #e9ecef; color: #6c757d;"><i class="fas fa-download"></i> PDF</a>
                  <a href="#" class="btn btn-sm disabled" style="background-color: #e9ecef; border-color: #e9ecef; color: #6c757d;"><i class="fas fa-eye"></i> PDF</a>
                </td>
                {% endif %}
              
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <nav aria-label="Page navigation example">
    <ul class="pagination justify-content-center">
      <li class="page-item {% if knp_pagination.currentPageNumber == 1 %}disabled{% endif %}">
        <a class="page-link" href="{{ path('app_client_getreser', {'page': knp_pagination.currentPageNumber - 1 }) }}" tabindex="-1"> < </a>
      </li>
      {% for page in 1..knp_pagination.pageCount %}
      <li class="page-item {% if page == knp_pagination.currentPageNumber %}active{% endif %}">
        <a class="page-link" href="{{ path('app_client_getreser', {'page': page }) }}">{{ page }}</a>
      </li>
      {% endfor %}
      <li class="page-item {% if knp_pagination.currentPageNumber == knp_pagination.pageCount %}disabled{% endif %}">
        <a class="page-link" href="{{ path('app_client_getreser', {'page': knp_pagination.currentPageNumber + 1 }) }}"> > </a>
      </li>
    </ul>
</nav>


</div>
<!-- Edit Ticket Number Modal -->
{% for reservation in reservations %}
<div class="modal fade" id="editModal{{ reservation.idReservation }}" tabindex="-1" role="dialog" aria-labelledby="editModalLabel{{ reservation.idReservation }}" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel{{ reservation.idReservation }}">Edit Ticket Number</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editForm{{ reservation.idReservation }}" action="{{ path('app_client_edit_reservation_tickets', {'id': reservation.idReservation}) }}" method="post">
                    <div class="form-group">
                        <label for="ticketsNumber{{ reservation.idReservation }}">New Ticket Number:</label>
                        <input type="number" class="form-control" id="ticketsNumber{{ reservation.idReservation }}" name="ticketsNumber" value="{{ reservation.ticketsNumber }}">
                        <label id="ticketsError{{ reservation.idReservation }}" style="color: red;"></label>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Gérer la soumission du formulaire de modification de réservation
    document.getElementById('editForm{{ reservation.idReservation }}').addEventListener('submit', function(event) {
        var ticketsNumber = document.getElementById('ticketsNumber{{ reservation.idReservation }}').value;
        var ticketsInput = document.getElementById('ticketsNumber{{ reservation.idReservation }}');
        var errorLabel = document.getElementById('ticketsError{{ reservation.idReservation }}');

        // Vérifier si le nombre de tickets est supérieur à 200
        if (ticketsNumber > 200) {
            errorLabel.textContent = "Nombre trop grand ! Veuillez saisir un nombre inférieur ou égal à 200.";
            errorLabel.style.color = 'red';
            ticketsInput.style.borderColor = 'red';
            event.preventDefault(); // Empêcher la soumission du formulaire
        } else {
            // Réinitialiser le label et le style du champ
            errorLabel.textContent = '';
            errorLabel.style.color = ''; // Réinitialiser la couleur du texte
            ticketsInput.style.borderColor = ''; // Réinitialiser la couleur de la bordure
        }
    });
</script>
{% endfor %}


<!-- Modal -->
<div id="pdfModal" class="modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Reservation PDF</h5>
        <button type="button" class="close" onclick="closePdfModal()">&times;</button>
      </div>
      <div class="modal-body">
        <iframe id="pdfFrame" src="" frameborder="0" style="width:100%;height:400px;"></iframe>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closePdfModal()">Close</button>
      </div>
    </div>
  </div>
</div>




{% block js %}

<script>
    const cancelButtons = document.querySelectorAll('.btn-danger');
  
    cancelButtons.forEach(button => {
      button.addEventListener('click', function(event) {
        event.preventDefault(); // Prevent default link behavior
  
        const confirmCancel = confirm('Are you sure you want to cancel this reservation?');
        if (confirmCancel) {
          window.location.href = this.dataset.href; // Redirect if confirmed
        }
      });
    });
  </script>
 
  <script>
    function openPdfModal(pdfUrl) {
      var modal = document.getElementById('pdfModal');
      var pdfFrame = document.getElementById('pdfFrame');
      pdfFrame.src = pdfUrl;
      modal.style.display = 'block';
    }
  
    function closePdfModal() {
      var modal = document.getElementById('pdfModal');
      var pdfFrame = document.getElementById('pdfFrame');
      pdfFrame.src = '';
      modal.style.display = 'none';
    }
  </script>
  {% endblock %}


{% endblock %}